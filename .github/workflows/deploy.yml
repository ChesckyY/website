name: deploy-ssh
on:
  workflow_dispatch:
  release:
    types: [published]

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Download app.zip from latest release
        uses: robinraju/release-downloader@v1.11
        with:
          repository: ${{ github.repository }}
          latest: true
          fileName: "app.zip"

      - name: Copy app.zip to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: 22
          source: "app.zip"
          target: "/srv/rusdi/" # User requested change back to /srv/rusdi/
          timeout: 60s
          command_timeout: 10m

      - name: Deploy via SSH (atomic release + systemd)
        uses: appleboy/ssh-action@v1.1.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: 22
          script: |
            set -euo pipefail
            
            # Create release folder
            ts="$(date -u +%Y-%m-%dT%H-%M-%SZ)"
            mkdir -p "/srv/rusdi/releases/$ts"

            # Unzip from /srv/rusdi/app.zip (since we uploaded there)
            unzip -o /srv/rusdi/app.zip -d "/srv/rusdi/releases/$ts"
            rm /srv/rusdi/app.zip

            # Install dependencies
            cd "/srv/rusdi/releases/$ts"
            if [ -f "package-lock.json" ]; then
              npm ci --omit=dev
            else
              npm install --omit=dev
            fi

            # Update symlink
            ln -sfn "/srv/rusdi/releases/$ts" /srv/rusdi/current

            # Restart service
            sudo systemctl restart rusdi

            # Health Check with retries (wait for slow startups)
            max_retries=6
            sleep_between=5
            attempt=0
            success=0
            while [ $attempt -lt $max_retries ]; do
              attempt=$((attempt + 1))
              sleep $sleep_between
              if curl -fsS http://localhost:3000/health >/dev/null 2>&1; then
                success=1
                echo "Health check passed on attempt $attempt"
                break
              fi
              echo "Health check attempt $attempt/$max_retries failed; retrying..."
            done

            if [ "$success" -ne 1 ]; then
              echo "Health check failed! Last logs:"
              # Show recent logs for the rusdi service, or general system logs if that fails
              sudo journalctl -u rusdi -n 200 --no-pager -o cat || sudo journalctl -xe --no-pager -n 200
              exit 1
            fi

            # Cleanup (keep 5 most recent)
            ls -1dt /srv/rusdi/releases/* | tail -n +6 | xargs -r rm -rf